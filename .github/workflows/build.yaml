name: Build
permissions:
  contents: write
on:
  workflow_call:
    inputs: 
      runner:
        type: string
        description: '运行器'
        required: true
        default: 'ubuntu-24.04'
      arch:
        type: string
        description: '架构'
        required: true
        default: 'amd64'
      max-tasks:
        type: number
        description: '最大任务数'
        required: false
        default: 10
      debug:
        type: boolean
        description: '启用调试'
        required: false
        default: ${{fromJSON(vars.ENABLE_DEBUG||'false')}}
    secrets:
      FTP_URL: 
        description: 'FTP地址'
      SSH_URL: 
        description: 'SSH地址'
      SSH_HOST_KEY:
        description: 'SSH服务器公钥'
      SSH_PRIVATE_KEY:
        description: 'SSH客户端私钥'
      CF_PROXY:
        description: 'CF代理'
  workflow_dispatch: 
    inputs:
      runner:
        type: string
        description: '运行器'
        required: true
        default: 'ubuntu-24.04'
      arch:
        type: string
        description: '架构'
        required: true
        default: 'amd64'
      max-tasks:
        type: number
        description: '最大任务数'
        required: false
        default: 10
      debug:
        type: boolean
        description: '启用调试'
        required: false
        default: false
  
jobs:
  list:
    runs-on: ${{inputs.runner}}
    outputs:
      tasks: ${{steps.check.outputs.TASKS}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Check
        id: check
        run: |
          git submodule update --init --remote
          make tasks MAX_TASKS=${{inputs.max-tasks}}
          echo "TASKS<<EOF" >> "$GITHUB_OUTPUT"
          cat "tasks.json" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        env:
          ARCH: ${{inputs.arch}}
  build:
    needs: list
    if: ${{needs.list.outputs.tasks!=''&&needs.list.outputs.tasks!='[]'}}
    strategy:
      max-parallel: 100
      matrix:
        pkg: ${{fromJson(needs.list.outputs.tasks)}}
      fail-fast: false
    runs-on: ${{inputs.runner}}
    env:
      ARCH: ${{inputs.arch}}
      PKGID: ${{matrix.pkg}}
      CACHE_DIR: caches
      PKG_WORK_DIR: caches/${{matrix.pkg}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Setup Essentials
        run: |
          # sudo apt update
          sudo apt install ostree xdotool scrot xvfb apt-file erofs-utils erofsfuse -y
          
          git -C build/$ARCH pull origin $ARCH
      - name: Check
        id: check
        run: |
          BASE=$(make -s base)
          echo "base=$BASE">>"$GITHUB_OUTPUT"
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/linglong-builder/
          key: linglong-${{env.ARCH}}-${{steps.check.outputs.base}}
      - name: Init
        run: |
          sudo sysctl -w kernel.unprivileged_userns_clone=1
          sudo sysctl -w user.max_user_namespaces=28633
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_unconfined=0
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      # - uses: valeriangalliat/action-sshd-cloudflared@v3
        # if: ${{true}}
      - name: Build
        run: |
          make build test||true
      - name: Test
        id: test
        run: |
          layer=no
          desktop=no
          fail=no
          if ls $PKG_WORK_DIR/*.layer >/dev/null;then
            layer=yes
          fi
          if ls $PKG_WORK_DIR/tests/screen*.jpg >/dev/null;then
            desktop=yes
          fi
          echo "desktop=$desktop"
          echo "layer=$layer"
          echo "fail=$fail"

          echo "desktop=$desktop" >>$GITHUB_OUTPUT
          echo "layer=$layer" >>$GITHUB_OUTPUT
          echo "fail=$fail" >>$GITHUB_OUTPUT
      - name: Upload
        if: ${{steps.test.outputs.fail=='no'}}
        run: |
          SSH_ARGS=()
          FTP_ARGS=()
          if [ -n "$CF_PROXY" ];then
            wget -nv https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-$ARCH -O cloudflared
            chmod +x cloudflared
            SSH_ARGS=(-o ProxyCommand='./cloudflared access tcp --hostname $CF_PROXY')
          fi
          if [ -n "$SSH_URL" ];then
            echo "Upload via SSH"
            mkdir -p ~/.ssh
            echo "$SSH_HOST_KEY" >> ~/.ssh/known_hosts
            echo "$SSH_PRIVATE_KEY" >> ~/.ssh/id_key
            chmod 700 -R ~/.ssh
            scp -i ~/.ssh/id_key "${SSH_ARGS[@]}" ${PKG_WORK_DIR}/*.layer "${SSH_URL}"
          fi
          if [ -n "$FTP_URL" ];then
            echo "Upload via FTP"
            curl "${FTP_ARGS[@]}" -T ${PKG_WORK_DIR}/*.layer "${FTP_URL}"
          fi
        env:
          FTP_URL: ${{secrets.FTP_URL}}
          SSH_URL: ${{secrets.SSH_URL}}
          SSH_HOST_KEY: ${{secrets.SSH_HOST_KEY}}
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
          CF_PROXY: ${{secrets.CF_PROXY}}
      - name: Commit
        run: |
            SRC_DIR="$PWD/$PKG_WORK_DIR"
            WORK_DIR=build/$ARCH
            HASH=$(git rev-parse --short HEAD)
            cd $WORK_DIR
            git pull origin $ARCH --rebase
            rm -rf "$PKGID"
            mkdir -p "$PKGID"
            shopt -s nullglob
            cp -arf $SRC_DIR/*.log $SRC_DIR/tests $SRC_DIR/*.mk $SRC_DIR/*.yaml $SRC_DIR/SHA*SUMS $SRC_DIR/version "$PKGID" 
            
            if [ "${{steps.test.outputs.fail}}" = "yes" ];then
              echo -n "-${HASH}">>$PKGID/version
            fi
            
            git add "$PKGID"
            git diff --cached --quiet || git commit -m "Update ${PKGID}"
            git pull origin $ARCH --rebase
            git push -u origin HEAD:$ARCH
      - uses: valeriangalliat/action-sshd-cloudflared@v3
        if: ${{failure() && inputs.debug }}
